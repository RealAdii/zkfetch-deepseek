"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.makeRpcTcpTunnel = void 0;
const utils_1 = require("../../utils");
/**
 * Makes a tunnel communication wrapper for a TCP tunnel.
 *
 * It listens for messages and disconnect events from the server,
 * and appropriately calls the `onMessage` and `onClose` callbacks.
 */
const makeRpcTcpTunnel = ({ tunnelId, client, onClose, onMessage, }) => {
    let closed = false;
    client.addEventListener('tunnel-message', onMessageListener);
    client.addEventListener('tunnel-disconnect-event', onDisconnectListener);
    client.addEventListener('connection-terminated', onConnectionTerminatedListener);
    return {
        write(message) {
            return client.sendMessage({
                tunnelMessage: { tunnelId, message }
            });
        },
        async close(err) {
            if (closed) {
                return;
            }
            onErrorRecv(err);
            await client.rpc('disconnectTunnel', { id: tunnelId });
        }
    };
    function onMessageListener({ data }) {
        if (data.tunnelId !== tunnelId) {
            return;
        }
        onMessage === null || onMessage === void 0 ? void 0 : onMessage(data.message);
    }
    function onDisconnectListener({ data }) {
        var _a;
        if (data.tunnelId !== tunnelId) {
            return;
        }
        onErrorRecv(((_a = data.error) === null || _a === void 0 ? void 0 : _a.code)
            ? utils_1.AttestorError.fromProto(data.error)
            : undefined);
    }
    function onConnectionTerminatedListener({ data }) {
        onErrorRecv(data);
    }
    function onErrorRecv(err) {
        var _a;
        (_a = client.logger) === null || _a === void 0 ? void 0 : _a.debug({ tunnelId, err }, 'TCP tunnel closed');
        client.removeEventListener('tunnel-message', onMessageListener);
        client.removeEventListener('tunnel-disconnect-event', onDisconnectListener);
        client.removeEventListener('connection-terminated', onConnectionTerminatedListener);
        onClose === null || onClose === void 0 ? void 0 : onClose(err);
        onClose = undefined;
        closed = true;
    }
};
exports.makeRpcTcpTunnel = makeRpcTcpTunnel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFrZS1ycGMtdGNwLXR1bm5lbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jbGllbnQvdHVubmVscy9tYWtlLXJwYy10Y3AtdHVubmVsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUVBLHFDQUF5QztBQVV6Qzs7Ozs7R0FLRztBQUNJLE1BQU0sZ0JBQWdCLEdBQXNDLENBQUMsRUFDbkUsUUFBUSxFQUNSLE1BQU0sRUFDTixPQUFPLEVBQ1AsU0FBUyxHQUNULEVBQUUsRUFBRTtJQUNKLElBQUksTUFBTSxHQUFHLEtBQUssQ0FBQTtJQUNsQixNQUFNLENBQUMsZ0JBQWdCLENBQUMsZ0JBQWdCLEVBQUUsaUJBQWlCLENBQUMsQ0FBQTtJQUM1RCxNQUFNLENBQUMsZ0JBQWdCLENBQUMseUJBQXlCLEVBQUUsb0JBQW9CLENBQUMsQ0FBQTtJQUN4RSxNQUFNLENBQUMsZ0JBQWdCLENBQUMsdUJBQXVCLEVBQUUsOEJBQThCLENBQUMsQ0FBQTtJQUVoRixPQUFPO1FBQ04sS0FBSyxDQUFDLE9BQU87WUFDWixPQUFPLE1BQU0sQ0FBQyxXQUFXLENBQUM7Z0JBQ3pCLGFBQWEsRUFBRSxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUU7YUFDcEMsQ0FBQyxDQUFBO1FBQ0gsQ0FBQztRQUNELEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRztZQUNkLElBQUcsTUFBTSxFQUFFLENBQUM7Z0JBQ1gsT0FBTTtZQUNQLENBQUM7WUFFRCxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUE7WUFDaEIsTUFBTSxNQUFNLENBQUMsR0FBRyxDQUFDLGtCQUFrQixFQUFFLEVBQUUsRUFBRSxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUE7UUFDdkQsQ0FBQztLQUNELENBQUE7SUFFRCxTQUFTLGlCQUFpQixDQUFDLEVBQUUsSUFBSSxFQUE4QjtRQUM5RCxJQUFHLElBQUksQ0FBQyxRQUFRLEtBQUssUUFBUSxFQUFFLENBQUM7WUFDL0IsT0FBTTtRQUNQLENBQUM7UUFFRCxTQUFTLGFBQVQsU0FBUyx1QkFBVCxTQUFTLENBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO0lBQzFCLENBQUM7SUFFRCxTQUFTLG9CQUFvQixDQUFDLEVBQUUsSUFBSSxFQUF1Qzs7UUFDMUUsSUFBRyxJQUFJLENBQUMsUUFBUSxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQy9CLE9BQU07UUFDUCxDQUFDO1FBRUQsV0FBVyxDQUNWLENBQUEsTUFBQSxJQUFJLENBQUMsS0FBSywwQ0FBRSxJQUFJO1lBQ2YsQ0FBQyxDQUFDLHFCQUFhLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUM7WUFDckMsQ0FBQyxDQUFDLFNBQVMsQ0FDWixDQUFBO0lBQ0YsQ0FBQztJQUVELFNBQVMsOEJBQThCLENBQUMsRUFBRSxJQUFJLEVBQXFDO1FBQ2xGLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUNsQixDQUFDO0lBRUQsU0FBUyxXQUFXLENBQUMsR0FBc0I7O1FBQzFDLE1BQUEsTUFBTSxDQUFDLE1BQU0sMENBQUUsS0FBSyxDQUFDLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxFQUFFLG1CQUFtQixDQUFDLENBQUE7UUFFNUQsTUFBTSxDQUFDLG1CQUFtQixDQUFDLGdCQUFnQixFQUFFLGlCQUFpQixDQUFDLENBQUE7UUFDL0QsTUFBTSxDQUFDLG1CQUFtQixDQUFDLHlCQUF5QixFQUFFLG9CQUFvQixDQUFDLENBQUE7UUFDM0UsTUFBTSxDQUFDLG1CQUFtQixDQUFDLHVCQUF1QixFQUFFLDhCQUE4QixDQUFDLENBQUE7UUFDbkYsT0FBTyxhQUFQLE9BQU8sdUJBQVAsT0FBTyxDQUFHLEdBQUcsQ0FBQyxDQUFBO1FBQ2QsT0FBTyxHQUFHLFNBQVMsQ0FBQTtRQUNuQixNQUFNLEdBQUcsSUFBSSxDQUFBO0lBQ2QsQ0FBQztBQUNGLENBQUMsQ0FBQTtBQTdEWSxRQUFBLGdCQUFnQixvQkE2RDVCIn0=